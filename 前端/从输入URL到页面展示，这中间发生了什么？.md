---
tags: [面试,浏览器,回流,重绘]
intro: 画图工具简单设计
type: [知识]
---
1. 用户输入
	1. 判断内容是否符合 URL 规范
		1. 非URL: 地址栏会使用浏览器默认的搜索引擎
		2. URL: 补充 URL 协议 (http / https)
2. 用户敲回车
	1. 执行 beforeunload 
	2. 判断 当前页面的 form 表单
3. 发送 URL 请求 
	1. 浏览器进程会通过进程间通信（IPC）把 URL 请求发送至网络进程
		1. DNS 解析: 获取请求域名的服务器 IP 地址。
		2. HTTPS: 那么还需要建立 TLS 连接 
		3. TCP: 建立 TCP 链接
		4. HTTP: 发送HTTP请求 ![[HTTP]]
		5. 得到响应内容
			1. 301 , 302 : 跳转重定向
			2. 200 : 浏览器处理该请求
				1. 判断 Content-Type 类型
					1. text/html: 准备渲染进程了。
					2. application/octet-stream : 提交给浏览器的下载管理器结束
4. 准备渲染进程 -> 创建或复用一个渲染进程
	1. 谷歌浏览器 ( 同一域,会使用同一个渲染进程 ) 规则:
		1. 通常情况, 打开新的页面会单独起一个进程渲染.
		2. 如果 A B 属于同一站点, 那么 B 页面会使用 A 页面的渲染进程; 如果有其他情况, 浏览器进程则会为 B 创建一个新的渲染进程
5. 提交文档 -> 网络进程将请求到的内容推给渲染进程. 
	1. 流程: 网络进程 - 200 -> 浏览器进程 -> 浏览器进程 -提交文档-> 渲染进程 (打开接收管道) -加载ing> 渲染进程 -加载完毕> 浏览器进程 (更新浏览器状态: 安全状态、地址栏的 URL、前进后退的历史状态，并更新 Web 页面)  
6. 渲染阶段
	1. [DOM] 构建 DOM 树 : HTML - 编译器 -> DOM树 (具体 AST 行为)
	2. [Style] 样式计算 : 
		1. 将样式文件 - 编译器 -> styleSheets 样式表 (类数组)
		2. 属性值标准化 -> 将属性规范成一种标准 `height:2rem` -> `height:20px`
		3. 计算出 DOM 树中每个节点的具体样式 保存在 ComputedStyle 中
			1. CSS 继承规则: 子 DOM 会继承 父 DOM 的样式 , 在样式计算过程中，会根据 DOM 节点的继承关系来合理计算节点样式。
			2. CSS 样式层叠: 按照规则, 一层一层的为DOM增加样式, 即 样式复盖.
	3. [Lagout]布局阶段 (回流)
		1. 创建布局树 -> 遍历 DOM 树中的所有可见节点, 并把这些节点加到布局树中 ( display:none , \<head> , \<script />)
		2. 根据布局树计算节点的坐标位置, 保存到布局树中.
	4. [Layer]分层阶段(回流)
		1. 将所有的 DOM 根据以下条件进行分层
			1. 有层叠上下文属性的元素 例 :`z-index` , `translateZ`  , `postion:fixed` , `filter:blue(5px)`,`opacity:.5`
			2. 需要剪裁（clip）的地方也会被创建为图层, 即 呗 `overflow:hidden` 裁切的 div 会被单独分一层.
		2. 最后将分层根据 dom 树关系组合成图层树.
		3. 参考 : [层叠上下文 - CSS：层叠样式表 | MDN](https://developer.mozilla.org/zh-CN/docs/Web/CSS/CSS_positioned_layout/Understanding_z-index/Stacking_context)

   5. [Paint] 图层绘制(重绘) -> 把图层信息转换成绘制命令 
	   1. 把图层的绘制拆分成很多小的绘制指令，然后再把这些指令按照顺序组成一个待绘制列表.
   7. [tiles]栅格化(合成)
	   1. 根据图层大小,将图层分为一小块一小块内容. -> 绘制列表分块
	   2. 判断用户展示的窗口(viewport) 
	   3. 根据用户展示的 viewport 确定那几块会被看到.
	   4. 将这几块内容发给GPU由GUP合成
   8. [draw quad , display] (合成) 合成和显示
	   1. 合成线程就会生成一个绘制图块的命令——“DrawQuad”, 然后将该命令提交给浏览器进程
	   2. 浏览器进程里面有一个叫 viz 的组件, 用来接收合成线程发过来的 DrawQuad 命令, 然后根据 DrawQuad 命令, 将其页面内容绘制到内存中, 最后再将内存显示在屏幕上.
7. done
![[Pasted image 20231022165217.png]]